---
- name: نصب داکر و تنظیم دسترسی بدون نیاز به sudo
  hosts: all
  become: true  # اجرای دستورات با دسترسی root

  tasks:
    - name: نصب پکیج‌های موردنیاز
      apt:
        name:
          - docker.io
          - docker-compose
        state: present
        update_cache: yes

    - name: اطمینان از وجود گروه داکر
      group:
        name: docker
        state: present

    - name: اضافه کردن کاربر به گروه داکر
      user:
        name: "{{ ansible_user | default('ubuntu') }}"  # تغییر به نام کاربر مورد نظر
        groups: docker
        append: yes

    - name: راه‌اندازی مجدد داکر برای اعمال تغییرات
      systemd:
        name: docker
        state: restarted
        enabled: yes

    - name: اعمال تغییرات گروه برای کاربر (بدون نیاز به logout)
      shell: newgrp docker
      args:
        executable: /bin/bash
      become_user: "{{ ansible_user | default('ubuntu') }}"
      changed_when: false
